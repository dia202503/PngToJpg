<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>PNG → JPG 変換</title>
    <style>
        :root {
            --bg: #0f172a;
            --fg: #e2e8f0;
            --muted: #94a3b8;
            --accent: #2563eb;
            --panel: #111827;
        }

        html, body {
            margin: 0;
            height: 100%;
            background: #0b1020;
            color: #e6edf3;
            font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif
        }

        header {
            position: sticky;
            top: 0;
            background: #1f2a44;
            color: #fff;
            padding: 14px 16px;
            font-size: 22px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,.25)
        }

        main {
            padding: 16px;
            max-width: 980px;
            margin: 0 auto
        }

        .card {
            background: #101827;
            border: 1px solid #24324d;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center
        }

            .row > * {
                margin: 4px 0
            }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            background: #2563eb;
            color: #fff;
            font-weight: 600
        }

            .btn:disabled {
                opacity: .5
            }

            .btn.sec {
                background: #334155
            }

        input[type="text"], input[type="color"], input[type="number"], select {
            background: #0b1428;
            color: #e6edf3;
            border: 1px solid #2a3a5d;
            border-radius: 8px;
            padding: 8px 10px
        }

        input[type="range"] {
            width: 220px
        }

        .hint {
            color: #9fb1d1;
            font-size: 12px
        }

        .counter {
            color: #a6e3a1;
            font-weight: 700
        }

        #log {
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            background: #0b1326;
            border: 1px solid #1f2a44;
            border-radius: 12px;
            min-height: 220px;
            max-height: 45vh;
            overflow: auto;
            padding: 12px
        }

        .bar {
            height: 8px;
            border-radius: 8px;
            background: #111c33;
            border: 1px solid #1e2a46;
            margin-top: 6px;
            overflow: hidden
        }

            .bar > i {
                display: block;
                height: 100%;
                width: 0;
                background: #22c55e
            }

        .sep {
            height: 1px;
            background: #1f2a44;
            margin: 12px 0
        }

        .muted {
            color: #9fb1d1
        }
    </style>

    <!-- JSZip（ZIP生成用） -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
    <!-- Pyodide（Python実行）: Pillow を使える環境なら Python で変換 -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"
            crossorigin="anonymous"></script>
</head>
<body>
    <header>PNG→JPG</header>
    <main>
        <div class="card">
            <div class="row">
                <button id="btnPickDir" class="btn">フォルダを選択</button>
                <span class="hint muted">※フォルダ選択は https:// または localhost で有効。Android WebView(MAUI) では無効です。</span>
            </div>
            <div class="row">
                <input id="fileInput" type="file" accept="image/png" multiple />
                <span class="muted">または、PNGファイルを選択</span>
            </div>

            <div class="sep"></div>

            <div class="row">
                <label>
                    JPEG 品質:
                    <input id="quality" type="range" min="1" max="100" value="90">
                    <span id="qv" class="counter">90</span>
                </label>
                <label>
                    背景色:
                    <input id="bgcolor" type="text" value="#ffffff" size="8">
                    <input id="bgpicker" type="color" value="#ffffff">
                </label>
                <label>
                    <input id="zipWithPng" type="checkbox"> 変換元PNGもZIPに入れる
                </label>
                <label>
                    バッチ:
                    <select id="batch">
                        <option>25</option>
                        <option>50</option>
                        <option selected>100</option>
                        <option>200</option>
                    </select> 件/回
                </label>
            </div>

            <div class="row" style="margin-top:10px">
                <button id="btnConvert" class="btn">選択したPNGを変換 → ZIPダウンロード</button>
                <button id="btnSaveLog" class="btn sec">ログ保存</button>
                <span class="muted">選択中: <span id="selCount" class="counter">0</span> ファイル</span>
            </div>

            <div class="bar"><i id="bar"></i></div>
        </div>

        <div class="card">
            <div class="hint">ログ</div>
            <div id="log"></div>
        </div>
    </main>

    <script>
        /* ====== 環境判定 & ユーティリティ ====== */
        const ua = navigator.userAgent.toLowerCase();
        const isAndroid = /android/.test(ua);
        const isWebView = /wv/.test(ua) || !!window.AndroidSaver; // MAUI のブリッジがあれば true
        const hasDirPicker = "showDirectoryPicker" in window;
        const $ = (id) => document.getElementById(id);
        const logEl = $("log");
        function now() { const d = new Date(); return `[${d.toTimeString().slice(0, 8)}] ` }
        function log(s) { logEl.textContent += s; logEl.scrollTop = logEl.scrollHeight; }
        function setProgress(p) { $("bar").style.width = `${p}%`; }
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function sanitizeHex(c) {
            let t = (c || "").trim();
            if (/^#[0-9a-f]{3}$/i.test(t)) t = "#" + t[1] + t[1] + t[2] + t[2] + t[3] + t[3];
            if (!/^#[0-9a-f]{6}$/i.test(t)) return "#ffffff";
            return t.toLowerCase();
        }

        /* ====== UI 初期化 ====== */
        $("qv").textContent = $("quality").value;
        $("quality").addEventListener("input", e => $("qv").textContent = e.target.value);
        $("bgpicker").addEventListener("input", e => $("bgcolor").value = e.target.value);

        if (!hasDirPicker || isWebView) {
            $("btnPickDir").disabled = true;
            $("btnPickDir").title = "この環境ではフォルダ選択は無効です";
        }

        let selectedFiles = []; // {name, file}

        /* ====== フォルダ／ファイル選択 ====== */
        $("btnPickDir").addEventListener("click", async () => {
            if (!hasDirPicker) return;
            try {
                log(now() + "フォルダピッカー表示…\n");
                const h = await window.showDirectoryPicker({ mode: "read" });
                log(now() + "フォルダ許可\n");
                selectedFiles = [];
                const t0 = performance.now();
                let count = 0;
                async function walk(dirHandle, path = "") {
                    for await (const [name, handle] of dirHandle.entries()) {
                        if (handle.kind === "directory") { await walk(handle, path + name + "/"); continue; }
                        if (!name.toLowerCase().endsWith(".png")) continue;
                        const file = await handle.getFile();
                        selectedFiles.push({ name: path + name, file });
                        count++;
                    }
                }
                await walk(h);
                const ms = Math.round(performance.now() - t0);
                log(now() + `フォルダ走査: ${count} 件, ${ms}ms\n`);
                $("selCount").textContent = selectedFiles.length;
            } catch (e) {
                log(now() + `フォルダ選択キャンセル/失敗: ${e}\n`);
            }
        });

        $("fileInput").addEventListener("change", e => {
            selectedFiles = [];
            for (const file of e.target.files) {
                if (file && file.type === "image/png") {
                    selectedFiles.push({ name: file.name, file });
                }
            }
            $("selCount").textContent = selectedFiles.length;
        });

        /* ====== 変換エンジン（Python or Canvas） ====== */
        let pyodide = null;
        let pillowOk = false;

        async function ensurePyodide() {
            if (pyodide) return;
            log(now() + "Pyodide 読込開始…\n");
            const t0 = performance.now();
            pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
            const ms = Math.round(performance.now() - t0);
            log(now() + `Pyodide 読込完了: ${ms}ms\n`);
            try {
                await pyodide.runPythonAsync(`
import sys, micropip
# Pillow は pyodide 本体に含まれているので通常は import のみ
try:
        import PIL
        from PIL import Image
        pillow_ok = True
except Exception:
        pillow_ok = False
`);
                pillowOk = pyodide.globals.get("pillow_ok");
                log(now() + (pillowOk ? "Python 関数定義準備…\n" : "Pillow未利用 → JS Canvasにフォールバック\n"));
                if (pillowOk) {
                    await pyodide.runPythonAsync(`
from js import console
import base64, io
from PIL import Image

def png_to_jpeg_b64(png_b64, quality, bg_hex):
        # png_b64: base64 (without header)
        raw = base64.b64decode(png_b64)
        im = Image.open(io.BytesIO(raw)).convert("RGBA")
        # 背景塗り
        r = int(bg_hex[1:3],16); g = int(bg_hex[3:5],16); b = int(bg_hex[5:7],16)
        bg = Image.new("RGB", im.size, (r,g,b))
        bg.paste(im, mask=im.split()[3] if im.mode=="RGBA" else None)
        out = io.BytesIO()
        bg.save(out, format="JPEG", quality=int(quality), optimize=True)
        return base64.b64encode(out.getvalue()).decode("ascii")
`);
                    log(now() + "Python 準備完了\n");
                }
            } catch (e) {
                log(now() + `Pyodide 初期化中エラー → JS Canvasへ: ${e}\n`);
                pillowOk = false;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result.split(",")[1]); // strip header
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
        }

        // Python(Pillow) で1件変換（base64→base64）
        async function convertOneByPython(file, q, bgHex) {
            const b64in = await fileToBase64(file);
            const b64out = await pyodide.runPythonAsync(`png_to_jpeg_b64(r"""${b64in}""", ${q}, "${bgHex}")`);
            // 返り値は PyProxy(str) → JS string
            return b64out.toString();
        }

        // Canvas で1件変換（Blob→Blob）
        async function convertOneByCanvas(file, q, bgHex) {
            const blob = file;
            const bmp = await createImageBitmap(blob);
            const canvas = new OffscreenCanvas(bmp.width, bmp.height);
            const ctx = canvas.getContext("2d");
            // 背景色
            ctx.fillStyle = bgHex;
            ctx.fillRect(0, 0, bmp.width, bmp.height);
            ctx.drawImage(bmp, 0, 0);
            const quality = Math.max(0.01, Math.min(1, q / 100));
            const outBlob = await canvas.convertToBlob({ type: "image/jpeg", quality });
            return await blobToBase64(outBlob);
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result.split(",")[1]);
                fr.onerror = reject;
                fr.readAsDataURL(blob);
            });
        }

        /* ====== ZIP 保存（Android ブリッジ or a[download]） ====== */
        async function saveZip(blob, filename) {
            // MAUI(Android) ブリッジ優先
            if (window.AndroidSaver && AndroidSaver.saveBase64) {
                try {
                    const b64 = await blobToBase64(blob);
                    AndroidSaver.saveBase64(b64, filename, "application/zip");
                    log(now() + `保存: Androidへ渡しました → ${filename}\n`);
                    return;
                } catch (e) {
                    log(now() + `保存エラー(AndroidSaver): ${e}\n`);
                }
            }
            // フォールバック（PC ブラウザ等）
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            log(now() + `保存: ブラウザのダウンロードで保存しました → ${filename}\n`);
        }

        /* ====== メイン処理 ====== */
        $("btnConvert").addEventListener("click", async () => {
            const files = selectedFiles.slice();
            if (files.length === 0) { log(now() + "選択ファイルがありません\n"); return; }

            const q = parseInt($("quality").value, 10);
            const bg = sanitizeHex($("bgcolor").value);
            const batchSize = parseInt($("batch").value, 10);
            const zipWithPng = $("zipWithPng").checked;

            // Python可ならロード
            await ensurePyodide();

            const total = files.length;
            let done = 0, ok = 0, ng = 0;
            setProgress(0);

            const zip = new JSZip();
            const outFolder = zip.folder("jpg")!;
            const pngFolder = zip.folder("png")!;

            log(now() + `Step A: 読み込み/準備 → base64化\n`);

            for (let i = 0; i < files.length; i += batchSize) {
                const chunk = files.slice(i, i + batchSize);
                log(now() + `Step B: 変換開始 (バッチ ${Math.floor(i / batchSize) + 1}/${Math.ceil(total / batchSize)})\n`);
                for (const { name, file } of chunk) {
                    try {
                        const stem = name.replace(/\.png$/i, "");
                        let b64jpg;

                        if (pyodide && pillowOk) {
                            b64jpg = await convertOneByPython(file, q, bg);
                        } else {
                            b64jpg = await convertOneByCanvas(file, q, bg);
                        }
                        outFolder.file(stem + ".jpg", b64jpg, { base64: true });
                        if (zipWithPng) { pngFolder.file(name, file); }
                        ok++;
                    } catch (e) {
                        log(now() + `NG: ${name} (${e})\n`);
                        ng++;
                    } finally {
                        done++;
                        const p = Math.round(done / total * 100);
                        setProgress(p);
                    }
                    // UI描画のため小休止
                    if ((done % 10) === 0) await sleep(0);
                }
            }

            log(now() + `Step C: ZIP 生成中…\n`);
            const zipBlob = await zip.generateAsync({ type: "blob", compression: "STORE" }); // 画像は可逆なのでSTOREでOK
            log(now() + `完了: 成功 ${ok}, 失敗 ${ng}\n`);

            const ts = new Date(); const y = ts.getFullYear(); const m = (ts.getMonth() + 1 + "").padStart(2, "0"); const d = (ts.getDate() + "").padStart(2, "0");
            const hh = (ts.getHours() + "").padStart(2, "0"), mm = (ts.getMinutes() + "").padStart(2, "0");
            const zipName = `png2jpg_${y}${m}${d}_${hh}${mm}.zip`;
            await saveZip(zipBlob, zipName);
        });

        /* ====== ログ保存 ====== */
        $("btnSaveLog").addEventListener("click", async () => {
            const text = logEl.textContent || "";
            const blob = new Blob([text], { type: "text/plain" });
            if (window.AndroidSaver && AndroidSaver.saveBase64) {
                const b64 = await blobToBase64(blob);
                AndroidSaver.saveBase64(b64, `png2jpg_log_${Date.now()}.txt`, "text/plain");
                log(now() + "ログをAndroidへ保存依頼\n");
                return;
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = `png2jpg_log_${Date.now()}.txt`;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        /* 初期ログ */
        log(now() + "起動\n");
        if (!hasDirPicker) log(now() + "この環境は showDirectoryPicker 非対応です\n");
        if (isWebView) log(now() + "Android WebView/Mobile 環境: フォルダ選択を無効化しています\n");
    </script>
</body>
</html>
